<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Compute optimal transport between unnormalized images / mass distributions (pgrid objects)
under the option that mass can be dispose of. Transport cost per unit is distance of transport to 
the p-th power. Disposal cost per unit is C^p."><!-- Inform modern browsers that this page supports both dark and light color schemes,
  and the page author prefers light. --><meta name="color-scheme" content="dark light"><script>
  // If `prefers-color-scheme` is not supported, fall back to light mode.
  // i.e. In this case, inject the `light` CSS before the others, with
  // no media filter so that it will be downloaded with highest priority.
  if (window.matchMedia("(prefers-color-scheme: dark)").media === "not all") {
    document.documentElement.style.display = "none";
    document.head.insertAdjacentHTML(
      "beforeend",
      "<link id=\"css\" rel=\"stylesheet\" href=\"https://bootswatch.com/5/flatly/bootstrap.css\" onload=\"document.documentElement.style.display = ''\">"
    );
  }
</script><title>Unbalanced Optimal Transport between pgrid Objects — unbalanced • transport</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Unbalanced Optimal Transport between pgrid Objects — unbalanced"><meta property="og:description" content="Compute optimal transport between unnormalized images / mass distributions (pgrid objects)
under the option that mass can be dispose of. Transport cost per unit is distance of transport to 
the p-th power. Disposal cost per unit is C^p."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Flatly Theme - Light  --><link id="css-light" rel="stylesheet" href="https://bootswatch.com/5/flatly/bootstrap.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><!-- Darkly Theme - Dark --><link id="css-dark" rel="stylesheet" href="https://bootswatch.com/5/darkly/bootstrap.css" media="(prefers-color-scheme: dark)"><!-- preferably CSS --><link rel="stylesheet" href="../preferably.css"><link id="css-code-light" rel="stylesheet" href="../code-color-scheme-light.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"><link id="css-code-dark" rel="stylesheet" href="../code-color-scheme-dark.css" media="(prefers-color-scheme: dark)"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">transport</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.14-6</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-2">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Example-Analysis.html">Example Analysis</a>
  </div>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"></ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Unbalanced Optimal Transport between pgrid Objects</h1>
      
      <div class="d-none name"><code>unbalanced.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Compute optimal transport between unnormalized images / mass distributions (<code>pgrid</code> objects)
under the option that mass can be dispose of. Transport cost per unit is distance of transport to 
the <code>p</code>-th power. Disposal cost per unit is <code>C^p</code>.<br></p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">unbalanced</span><span class="op">(</span></span>
<span>  <span class="va">a</span>,</span>
<span>  <span class="va">b</span>,</span>
<span>  p <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  C <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"networkflow"</span>, <span class="st">"revsimplex"</span><span class="op">)</span>,</span>
<span>  output <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dist"</span>, <span class="st">"all"</span>, <span class="st">"rawres"</span><span class="op">)</span>,</span>
<span>  threads <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>a, b</dt>
<dd><p>objects of class <code><a href="pgrid.html">pgrid</a></code> that are compatible.</p></dd>


<dt>p</dt>
<dd><p>a power \(\geq 1\) applied to the transport and disposal costs. The order
of the resulting unbalanced Wasserstein metric.</p></dd>


<dt>C</dt>
<dd><p>The base disposal cost (without the power <code>p</code>)</p></dd>


<dt>method</dt>
<dd><p>one of <code>"networkflow"</code> and <code>"revsimplex"</code>, specifing the algorithm used. See details.</p></dd>


<dt>output</dt>
<dd><p>character. One of "dist", "all" and "rawres". Determines what the function
returns: only the unbalanced Wasserstein distance; all available information about the 
transport plan and the extra mass; or the raw result obtained by the networkflow algorithm.
The latter is the same format as in the <code>transport</code> function with option <code>fullreturn=TRUE</code>.
The choice <code>output = "rawres"</code> is mainly intended for internal use.</p></dd>


<dt>threads</dt>
<dd><p>an integer specifying the number of threads for parallel computing in connection with
the networkflow method.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>If <code>output = "dist"</code> a single numeric, the unbalanced \((p,C)\)-Wasserstein distance.
Otherwise a list. If <code>output = "all"</code> the list saves <code>a</code>, <code>b</code>, <code>p</code>, <code>C</code> as attributes and 
has the following components:</p>
<dl><dt>dist</dt>
<dd><p>same as for <code>output = "dist"</code>.</p></dd>

<dt>plan</dt>
<dd><p>an optimal transport plan. This is a data frame with columns <code>from</code>, <code>to</code> and <code>mass</code>
 that specifies from which element of <code>a</code> to which element of <code>b</code> what amount of mass is sent.
 <code>from</code> and <code>to</code> are specified as vector indices in terms of the usual column major enumeration
 of the matrices a$mass and b$mass. The plan can be plotted via <code>plot.pgrid(a, b, plan)</code>.</p></dd>

<dt>atrans, btrans</dt>
<dd><p>matrices specifying the masses transported from each point and to each point,
 respectively. Corresponds to \((\pi^{(1)}_x)_{x \in G}\) and \((\pi^{(2)}_y)_{y \in G}\) above.</p></dd>

<dt>aextra, bextra</dt>
<dd><p>matrices specifying the amount of mass at each point of <code>a</code> and <code>b</code>,
respectively, that cannot be transported and needs to be disposed of. Corresponds to
\((a_x - \pi^{(1)}_x)_{x \in G}\) and \((b_y - \pi^{(2)}_y)_{y \in G}\).</p></dd>

<dt>inplace</dt>
<dd><p>a matrix specifying the amount of mass at each point that can stay in place. Corresponds
to \((\pi_{x,x})_{x \in G}\).</p></dd>

 
</dl><p>Note that <code>atrans + aextra + inplace</code> must be equal to <code>a$mass</code> and likewise for b.
A warning occurs if this is not the case (which may indeed happen from time to time for method
revsimplex, but the error reported should be very small).</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Given two non-negative mass distributions ("images") \(a=(a_x)_{x \in G}\), \(b=(a_y)_{y \in G}\)
on a grid \(G\), this function minimizes the functional
$$\sum_{x,y \in G} \pi_{x,y} d(x,y)^p + C^p \bigl( \sum_{x \in G} (a_x - \pi^{(1)}_x) + \sum_{y \in G} (b_y - \pi^{(2)}_y) \bigr)$$
over all \((\pi_{x,y})_{x,y \in G}\) satisfying
$$0 \leq \pi^{(1)}_x := \sum_{y \in G} \pi_{x,y} \leq a_x \ \textrm{and} \ 0 \leq \pi^{(2)}_y := \sum_{x \in G} \pi_{x,y} \leq b_y.$$</p>
<p>Thus \(\pi_{x,y}\) denotes the amount of mass transported from \(x\) to \(y\), whereas \(\pi^{(1)}_x\)
and \(\pi^{(2)}_y\) are the total mass transported away from \(x\) and total mass transported to \(y\), respectively.
Accordingly \(\sum_{x \in G} (a_x - \pi^{(1)}_x)\) and \(\sum_{y \in G} (b_y - \pi^{(2)}_y)\) are the total
amounts of mass of \(a\) and \(b\), respectively, that need to be disposed of.</p>
<p>The minimal value of the functional above taken to the \(1/p\) is what we refer to as unbalanced
\((p,C)\)-Wasserstein metric. This metric is used, in various variants, in an number of research papers.
See Heinemann et al. (2022) and the references therein and Müller et al. (2022), Remark 3. We follow the
convention of the latter paper regarding the parametrization and the use of the term <em>unbalanced Wasserstein metric</em>.</p>
<p>The practical difference between the two methods "networkflow" and "revsimplex" can 
roughly described as follows. The former is typically faster for large examples (64x64
and beyond), especially if several threads are used. The latter is typically faster
for smaller examples (which may be relevant if pairwise transports between many objects
are computed) and it guarantees a sparse(r) solution, i.e. at most m+n+1 individual
transports, where m and n are the number of non-zero masses in <code>a</code> and <code>b</code>, respectively).
Note however that due to the implementation the revsimplex algorithm is a little less
precise (roughly within 1e-7 tolerance). For more details on the algorithms see <code><a href="transport.html">transport</a></code>.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Florian Heinemann, Marcel Klatt and Axel Munk (2022).<br>
            Kantorovich-Rubinstein distance and barycenter for finitely supported measures: Foundations and Algorithms.<br>
            Arxiv preprint.<br>
            doi: <a href="https://doi.org/10.48550/arXiv.2112.03581" class="external-link">10.48550/arXiv.2112.03581</a>
<br><br>
            Raoul Müller, Dominic Schuhmacher and Jorge Mateu (2020).<br>
            Metrics and barycenters for point pattern data
            Statistics and Computing 30, 953-972.<br>
            doi: <a href="https://doi.org/10.1007/s11222-020-09932-y" class="external-link">10.1007/s11222-020-09932-y</a></p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code>kr_dist</code> in the package <code>WSGeometry</code>, which performs a similar task with more flexible input
(may be image files or <code><a href="wpp-object.html">wpp-object</a>s</code>). The present function gives more informative output and is currently better
optimized for images if <code>p=1</code> or if the image has many zeros.</p>
<p><code><a href="plot.ubtrans.html">plot.ubtrans</a></code>, which can plot the various components of the list obtained for <code>output="all"</code>.</p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="pgrid.html">pgrid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="pgrid.html">pgrid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">12</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">res1</span> <span class="op">&lt;-</span> <span class="fu">unbalanced</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="fl">1</span>, <span class="fl">0.5</span>, output<span class="op">=</span><span class="st">"all"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">res2</span> <span class="op">&lt;-</span> <span class="fu">unbalanced</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="fl">1</span>, <span class="fl">0.3</span>, output<span class="op">=</span><span class="st">"all"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="va">res1</span><span class="op">$</span><span class="va">plan</span>, angle<span class="op">=</span><span class="fl">20</span>, rot<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="unbalanced-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="va">res2</span><span class="op">$</span><span class="va">plan</span>, angle<span class="op">=</span><span class="fl">20</span>, rot<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="unbalanced-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="matimage.html">matimage</a></span><span class="op">(</span><span class="va">res2</span><span class="op">$</span><span class="va">aextra</span>, x <span class="op">=</span> <span class="va">a</span><span class="op">$</span><span class="va">generator</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">a</span><span class="op">$</span><span class="va">generator</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="matimage.html">matimage</a></span><span class="op">(</span><span class="va">res2</span><span class="op">$</span><span class="va">bextra</span>, x <span class="op">=</span> <span class="va">b</span><span class="op">$</span><span class="va">generator</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">b</span><span class="op">$</span><span class="va">generator</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="unbalanced-3.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="copyright">
  <p></p><p>Developed by Dominic Schuhmacher, Björn Bähre, Nicolas Bonneel, Carsten Gottschlich, Valentin Hartmann, Florian Heinemann, Bernhard Schmitzer, Jörn Schrieber.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
  <p class="preferably">Using <a href="https://preferably.amirmasoudabdol.name/?source=footer" class="external-link">preferably</a> template.</p>
</div>

    </footer></div>

  

  

  </body></html>

